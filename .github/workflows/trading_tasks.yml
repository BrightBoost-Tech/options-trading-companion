# Trading Tasks - Security v4 HMAC Signed Requests
#
# This workflow calls /tasks/* endpoints with v4 HMAC signing.
# Schedules are in UTC but include Python time-gate for DST-aware Chicago time.
#
# Required Secrets:
#   TASK_SIGNING_KEYS  - Format: kid1:secret1,kid2:secret2
#   QUANTUM_BASE_URL   - API base URL (e.g., https://api.example.com)
#
# Optional Secrets:
#   TASK_USER_ID       - Run tasks for specific user only

name: Trading Tasks (v4 Signed)

on:
  schedule:
    # Suggestions Close - 8:00 AM Chicago
    # CST (winter): 14:00 UTC | CDT (summer): 13:00 UTC
    # Schedule at 13:00 UTC to catch both; time-gate handles the rest
    - cron: '0 13 * * 1-5'

    # Suggestions Open - 11:00 AM Chicago
    # CST (winter): 17:00 UTC | CDT (summer): 16:00 UTC
    # Schedule at 16:00 UTC to catch both
    - cron: '0 16 * * 1-5'

    # Learning Ingest - 4:10 PM Chicago
    # CST (winter): 22:10 UTC | CDT (summer): 21:10 UTC
    # Schedule at 21:10 UTC to catch both
    - cron: '10 21 * * 1-5'

    # Ops Health Check - Every 30 min during market hours
    # Runs at :00 and :30 from 13:00-22:00 UTC (8 AM - 5 PM Chicago approx)
    - cron: '0,30 13-22 * * 1-5'

    # Validation Eval (Checkpoint) - 6:30 PM Chicago (after market close)
    # CST (winter): 00:30 UTC next day | CDT (summer): 23:30 UTC
    # Schedule at 23:30 UTC to catch CDT; time-gate bypassed
    - cron: '30 23 * * 1-5'

    # Learning Ingest Nightly - 3:30 AM Chicago (deep night, Tue-Sat)
    # CST (winter): 09:30 UTC | CDT (summer): 08:30 UTC
    # Schedule at 08:30 UTC; runs Tue-Sat to process Mon-Fri data
    - cron: '30 08 * * 2-6'

    # Paper Auto-Execute - 11:30 AM Chicago (after suggestions/open)
    # CST (winter): 17:30 UTC | CDT (summer): 16:30 UTC
    # Schedule at 16:30 UTC to catch CDT
    - cron: '30 16 * * 1-5'

    # Paper Auto-Close - 3:30 PM Chicago (before market close)
    # CST (winter): 21:30 UTC | CDT (summer): 20:30 UTC
    # Schedule at 20:30 UTC to catch CDT
    - cron: '30 20 * * 1-5'

    # Shadow Checkpoint Midday - 1:00 PM Chicago (intraday pacing check)
    # CST (winter): 19:00 UTC | CDT (summer): 18:00 UTC
    # Schedule at 19:00 UTC to catch both
    - cron: '0 19 * * 1-5'

    # Shadow Checkpoint Afternoon - 4:00 PM Chicago (pre-close pacing check)
    # CST (winter): 22:00 UTC | CDT (summer): 21:00 UTC
    # Schedule at 22:00 UTC to catch both
    - cron: '0 22 * * 1-5'

    # Cohort Eval Afternoon - 4:05 PM Chicago (multi-threshold analysis)
    # CST (winter): 22:05 UTC | CDT (summer): 21:05 UTC
    # Schedule at 22:05 UTC to catch both
    - cron: '5 22 * * 1-5'

    # Autopromote Cohort - 4:15 PM Chicago (after cohort eval)
    # CST (winter): 22:15 UTC | CDT (summer): 21:15 UTC
    # Schedule at 22:15 UTC to catch both
    - cron: '15 22 * * 1-5'

    # v4-L1F: Readiness Hardening Tasks

    # Validation Init Window - 8:40 AM Chicago (before suggestions-open)
    # CST (winter): 14:40 UTC | CDT (summer): 13:40 UTC
    # Schedule at 14:40 UTC to catch both
    - cron: '40 14 * * 1-5'

    # Validation Preflight Midday - 1:00 PM Chicago (intraday pacing check)
    # CST (winter): 19:00 UTC | CDT (summer): 18:00 UTC
    # Schedule at 19:00 UTC (overlaps with shadow midday, runs after)
    - cron: '5 19 * * 1-5'

    # Paper Safety Close One - 5:00 PM Chicago (must be before 6:30 PM checkpoint)
    # CST (winter): 23:00 UTC | CDT (summer): 22:00 UTC
    # Schedule at 23:00 UTC to catch both
    - cron: '0 23 * * 1-5'

  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - suggestions_close
          - suggestions_open
          - learning_ingest
          - universe_sync
          - morning_brief
          - midday_scan
          - weekly_report
          - validation_eval
          - strategy_autotune
          - ops_health_check
          - paper_auto_execute
          - paper_auto_close
          - validation_shadow_eval
          - validation_cohort_eval
          - validation_autopromote_cohort
          - validation_preflight
          - validation_init_window
          - paper_safety_close_one
      skip_time_gate:
        description: 'Skip time gate check'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (print request without sending)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Scheduled: Suggestions Close (8 AM Chicago)
  # ============================================================================
  suggestions-close:
    name: Suggestions Close (8 AM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 13 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Suggestions Close
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py suggestions_close

  # ============================================================================
  # Scheduled: Suggestions Open (11 AM Chicago)
  # ============================================================================
  suggestions-open:
    name: Suggestions Open (11 AM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 16 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Suggestions Open
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py suggestions_open

  # ============================================================================
  # Scheduled: Learning Ingest (4:10 PM Chicago)
  # ============================================================================
  learning-ingest:
    name: Learning Ingest (4:10 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '10 21 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Learning Ingest
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py learning_ingest

  # ============================================================================
  # Scheduled: Ops Health Check (every 30 min)
  # ============================================================================
  ops-health-check:
    name: Ops Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0,30 13-22 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Ops Health Check
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
        run: |
          python scripts/run_signed_task.py ops_health_check --skip-time-gate

  # ============================================================================
  # Manual Dispatch: Any Task
  # ============================================================================
  manual-task:
    name: Manual Task (${{ inputs.task }})
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Task
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
          DRY_RUN: ${{ inputs.dry_run && '1' || '0' }}
        run: |
          ARGS="${{ inputs.task }}"
          if [ "${{ inputs.skip_time_gate }}" = "true" ]; then
            ARGS="$ARGS --skip-time-gate"
          fi
          python scripts/run_signed_task.py $ARGS

  # ============================================================================
  # Scheduled: Validation Eval / Checkpoint (6:30 PM Chicago, after market close)
  # ============================================================================
  validation-eval:
    name: Validation Eval (6:30 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 23 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Validation Eval
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_eval --skip-time-gate

  # ============================================================================
  # Scheduled: Learning Ingest Nightly (3:30 AM Chicago, Tue-Sat)
  # ============================================================================
  learning-ingest-nightly:
    name: Learning Ingest Nightly (3:30 AM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 08 * * 2-6'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Learning Ingest Nightly
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py learning_ingest --skip-time-gate

  # ============================================================================
  # Scheduled: Paper Auto-Execute (11:30 AM Chicago)
  # ============================================================================
  paper-auto-execute:
    name: Paper Auto-Execute (11:30 AM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 16 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Paper Auto-Execute
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py paper_auto_execute --skip-time-gate

  # ============================================================================
  # Scheduled: Paper Auto-Close (3:30 PM Chicago)
  # ============================================================================
  paper-auto-close:
    name: Paper Auto-Close (3:30 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '30 20 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Paper Auto-Close
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py paper_auto_close --skip-time-gate

  # ============================================================================
  # Scheduled: Shadow Checkpoint Midday (1:00 PM Chicago)
  # ============================================================================
  validation-shadow-midday:
    name: Shadow Checkpoint Midday (1:00 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 19 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Shadow Checkpoint Midday
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_shadow_eval --skip-time-gate

  # ============================================================================
  # Scheduled: Shadow Checkpoint Afternoon (4:00 PM Chicago)
  # ============================================================================
  validation-shadow-afternoon:
    name: Shadow Checkpoint Afternoon (4:00 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 22 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Shadow Checkpoint Afternoon
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_shadow_eval --skip-time-gate

  # ============================================================================
  # Scheduled: Cohort Eval Afternoon (4:05 PM Chicago)
  # ============================================================================
  validation-cohort-afternoon:
    name: Cohort Eval Afternoon (4:05 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '5 22 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Cohort Eval Afternoon
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_cohort_eval --skip-time-gate

  # ============================================================================
  # Scheduled: Autopromote Cohort (4:15 PM Chicago)
  # ============================================================================
  validation-autopromote-cohort:
    name: Autopromote Cohort (4:15 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '15 22 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Autopromote Cohort
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_autopromote_cohort --skip-time-gate

  # ============================================================================
  # v4-L1F: Readiness Hardening Tasks
  # ============================================================================

  # ============================================================================
  # Scheduled: Validation Init Window (8:40 AM Chicago)
  # ============================================================================
  validation-init-window:
    name: Validation Init Window (8:40 AM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '40 14 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Validation Init Window
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_init_window --skip-time-gate

  # ============================================================================
  # Scheduled: Validation Preflight Midday (1:05 PM Chicago)
  # ============================================================================
  validation-preflight-midday:
    name: Validation Preflight Midday (1:05 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '5 19 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Validation Preflight
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py validation_preflight --skip-time-gate

  # ============================================================================
  # Scheduled: Paper Safety Close One (5:00 PM Chicago)
  # ============================================================================
  paper-safety-close-one:
    name: Paper Safety Close One (5:00 PM Chicago)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 23 * * 1-5'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/quantum/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r packages/quantum/requirements.txt

      - name: Run Paper Safety Close One
        env:
          TASK_SIGNING_KEYS: ${{ secrets.TASK_SIGNING_KEYS }}
          BASE_URL: ${{ secrets.QUANTUM_BASE_URL }}
          USER_ID: ${{ secrets.TASK_USER_ID }}
        run: |
          python scripts/run_signed_task.py paper_safety_close_one --skip-time-gate
